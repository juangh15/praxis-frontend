pipeline {
    agent any
    stages{
        stage('Set TERM'){
          steps {
            sh "TERM=dumb"
          }
        }
        stage('Install dependencies') {
            steps {
                sh '''
                    npm install -D cypress --save-dev
                    npm install mocha mochawesome cypress-mochawesome-reporter --save-dev
                    npm install cypress-multi-reporters --save-dev
                    npm install mochawesome-merge --save-dev
                    npm install mochawesome-report-generator --save-dev
                '''
            }
        }

        stage('Run cypress tests') {
            steps {
                sh '''
                    npm run pretest
                    npm test
                    npm run combine-reports
                    npm run generate-report
                '''
            }
        }
        
        stage('Publish test report') {
            steps {
                publishHTML (target : [allowMissing: false,
                 alwaysLinkToLastBuild: true,
                 keepAll: true,
                 reportDir: '/var/lib/jenkins/workspace/ci-ui_test/cypress/reports',
                 reportFiles: 'report.html',
                 reportName: 'Cypress report',
                 reportTitles: 'Cypress report'])   
                sh "zip -r CypressTesting.zip cypress/reports/"
                slackSend message:"You can acces by clicking http://3.233.167.141:8080/job/ci-ui_test/$BUILD_NUMBER/Cypress_20report/"
            }
            
        }
       } 
       post {
        always {
            slackUploadFile filePath: 'CypressTesting.zip', initialComment: 'This the test report for Build $BUILD_NUMBER', credentialId: 'slackCredential'
            emailext attachmentsPattern: '**/CypressTesting.zip', body: 'This is a test email', mimeType: 'text/html', subject: 'Build $BUILD_NUMBER - $BUILD_STATUS', to: 'grupo3.praxis@outlook.com'
        }   
      }
    
}
